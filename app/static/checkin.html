<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活动签到</title>
    
    <script type="text/javascript">
        window._AMapSecurityConfig = {
           serviceHost: 'https://havenchannel.xyz/_AMapService',
        }
    </script>
    <script type="text/javascript" 
            src="https://webapi.amap.com/maps?v=2.0&key=3b5f49eb59da5745a5f054734d1d5889"> // 替换为您的 Key
    </script>

    <style>
        /* 样式表 (保持不变) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #container {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
        }
        header h2 {
            margin: 0;
            color: #007bff;
            font-size: 1.5rem;
            text-align: center;
        }
        main {
            padding: 1rem 2rem 2rem 2rem;
        }
        .info-group {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #555;
        }
        .info-group strong {
            color: #333;
            min-width: 50px;
            display: inline-block;
        }
        #map {
            width: 100%;
            height: 250px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 1rem;
        }
        /* 移除了 .form-group 输入框样式，因为不再需要输入学号姓名 */
        
        button {
            width: 100%;
            padding: 0.85rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem; /* 稍微增加顶部间距 */
        }
        #checkInButton {
            background-color: #007bff;
            color: white;
        }
        #checkInButton:hover {
            background-color: #0056b3;
        }
        #checkInButton:disabled {
            background-color: #a0a0a0;
        }
        #checkOutButton {
            background-color: #dc3545;
            color: white;
        }
        #checkOutButton:hover {
            background-color: #c82333;
        }
        #checkOutButton:disabled {
            background-color: #a0a0a0;
        }
        #message {
            text-align: center;
            padding: 1rem 0 0 0;
            font-weight: bold;
            font-size: 0.9rem;
            word-wrap: break-word;
        }
        .success { color: green; }
        .error { color: red; }
        
        #loading {
            padding: 3rem;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="container">
        
        <div id="loading">
            <div class="loader"></div>
            <p>正在加载活动信息...</p>
        </div>
        
        <div id="content" style="display:none;">
            <header>
                <h2 id="activityName"></h2>
            </header>
            
            <main>
                <div id="activityInfo">
                    <div class="info-group">
                        <strong title="地点">地点:</strong> <span id="activityLocation"></span>
                    </div>
                    <div class="info-group">
                        <strong title="时间">时间:</strong> <span id="activityTime"></span>
                    </div>
                    <div id="map"></div>
                </div>

                <div id="checkInForm" style="display:none;">
                    <h3 style="text-align: center;">点击按钮进行签到</h3>
                    <button id="checkInButton">立即签 到</button>
                </div>

                <div id="checkOutForm" style="display:none;">
                    <h3>您已签到</h3>
                    <p>如需签退，请点击下方按钮。</p>
                    <button id="checkOutButton">签 退</button>
                </div>

                <div id="message"></div>
            </main>
        </div>
    </div>

    <script>
        // --- 核心JS逻辑 ---
        // 修改点：全局变量中获取 Token
        const studentToken = localStorage.getItem('student_token');
        const urlParams = new URLSearchParams(window.location.search);
        const activityCode = urlParams.get('code');
        const tokenStorageKey = `device_session_token_${activityCode}`; // 用于存储签退用的临时Token

        // DOM 元素
        const loadingDiv = document.getElementById('loading');
        const contentDiv = document.getElementById('content');
        const checkInForm = document.getElementById('checkInForm');
        const checkOutForm = document.getElementById('checkOutForm');
        const messageDiv = document.getElementById('message');
        const checkInButton = document.getElementById('checkInButton');
        const checkOutButton = document.getElementById('checkOutButton');

        // 地图变量
        var map;
        var activityCircle;
        var activityMarker;
        var studentMarker;
        var amapGeolocation; 

        // 在页面加载时运行
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. 基础检查
            if (!studentToken) {
                window.location.href = `student_login.html?redirect_code=${activityCode || ''}`;
                return;
            }

            if (!activityCode) {
                showMessage('无效的活动链接', true);
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                // 2. 并行请求：获取活动信息 + 获取用户签到状态 (Cloud Sync!)
                const [actResp, statusResp] = await Promise.all([
                    fetch(`/students_system/api/participant/activity/${activityCode}`),
                    fetch(`/students_system/api/participant/status`, {
                        headers: { 'Authorization': `Bearer ${studentToken}` }
                    })
                ]);

                // 处理活动信息
                if (!actResp.ok) throw new Error('活动加载失败');
                const activity = await actResp.json();
                
                // 填充页面
                document.getElementById('activityName').innerText = activity.name;
                document.getElementById('activityLocation').innerText = activity.location_name;
                document.getElementById('activityTime').innerText = `${new Date(activity.start_time).toLocaleString()} - ${new Date(activity.end_time).toLocaleString()}`;
                
                if (activity.longitude != null) initMap(activity);

                // 3. 处理签到状态 (核心修改)
                const statusData = await statusResp.json();
                
                // 如果服务器说“已签到”，不管本地有没有 Token，都显示签退界面
                if (statusData.is_checked_in) {
                    // 只有当服务器返回的活动正是当前扫码的活动时，才允许签退
                    if (statusData.activity_code === activityCode) {
                        checkInForm.style.display = 'none';
                        checkOutForm.style.display = 'block';
                        showMessage('检测到您已在其他设备签到，可直接签退', false);
                    } else {
                        // 正在进行 A 活动，却扫了 B 活动的码
                        checkInForm.style.display = 'none';
                        checkOutForm.style.display = 'none';
                        showMessage(`您正在参与 "${statusData.activity_name}"，无法在此签到/签退`, true);
                    }
                } else {
                    // 没签到
                    checkInForm.style.display = 'block';
                    checkOutForm.style.display = 'none';
                }

            } catch (error) {
                showMessage(`加载失败: ${error.message}`, true);
                if (error.message.includes('401')) { // 如果 Token 失效
                    localStorage.removeItem('student_token');
                    window.location.href = `student_login.html?redirect_code=${activityCode}`;
                }
            }
            
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        });

        // 地图初始化 (保持不变)
        function initMap(activity) {
            const center = [activity.longitude, activity.latitude];
            map = new AMap.Map('map', {
                zoom: 16,
                center: center
            });

            AMap.plugin(['AMap.Circle', 'AMap.Marker', 'AMap.Geolocation'], function() {
                activityMarker = new AMap.Marker({ position: center, title: activity.location_name });
                map.add(activityMarker);

                activityCircle = new AMap.Circle({
                    center: center,
                    radius: activity.radius_meters,
                    borderWeight: 2,
                    strokeColor: "#007bff",
                    strokeOpacity: 1,
                    fillColor: "#007bff",
                    fillOpacity: 0.2,
                    zIndex: 50,
                });
                map.add(activityCircle);
                map.setFitView([activityCircle]);

                studentMarker = new AMap.Marker({
                    icon: "https://webapi.amap.com/theme/v1.3/markers/n/loc.png",
                    offset: new AMap.Pixel(-13, -30)
                });
                map.add(studentMarker);

                amapGeolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, 
                    timeout: 10000,           
                    maximumAge: 0,            
                    convert: true,           
                    extensions: 'all',        
                    showButton: false,        
                    showMarker: false,        
                    showCircle: false,        
                });
                getCurrentStudentPosition();
            });
        }
        
        function updateStudentPosition(lat, lon) {
            if (studentMarker) {
                const position = new AMap.LngLat(lon, lat);
                studentMarker.setPosition(position);
                studentMarker.show();
            }
        }
        
        function getCurrentStudentPosition() {
            // 仅显示状态，不提示错误（错误在点击按钮时处理）
            if (amapGeolocation) {
                amapGeolocation.getCurrentPosition(function(status, result) {
                    if (status === 'complete' && result.info === 'SUCCESS') {
                        const lat = result.position.lat;
                        const lon = result.position.lng; 
                        updateStudentPosition(lat, lon);
                        if (map && studentMarker) map.setCenter(studentMarker.getPosition());
                    }
                });
            }
        }

        // --- 签到逻辑 ---
        // 修改点：不再验证输入框，直接执行操作
        checkInButton.addEventListener('click', () => {
            performAction('checkin', {}); 
        });

        // --- 签退逻辑 ---
        checkOutButton.addEventListener('click', () => {
            // 修改：跨设备签退不需要本地 deviceToken，直接发起请求
            // 身份验证现在由 Authorization Header (studentToken) 负责
            performAction('checkout', {}); 
        });

        // 8. 统一的动作执行器 (核心修改)
        function performAction(type, payload) {
            showMessage('正在获取您的位置信息...', false);
            checkInButton.disabled = true;
            checkOutButton.disabled = true;

            if (!amapGeolocation) {
                showMessage('定位插件未加载，请刷新页面', true);
                checkInButton.disabled = false;
                checkOutButton.disabled = false;
                return;
            }

            amapGeolocation.getCurrentPosition(async function(status, result) {
                if (status === 'complete' && result.info === 'SUCCESS') {
                    const lat = result.position.lat;
                    const lon = result.position.lng;
                    
                    updateStudentPosition(lat, lon);
                    showMessage(`位置获取成功 (精度: ${result.accuracy || '未知'} 米)，正在提交...`, false);

                    // 准备发起请求
                    let response;
                    let resultData;
                    
                    // 获取 Token (确保已定义)
                    const studentToken = localStorage.getItem('student_token');

                    try {
                        if (type === 'checkin') {
                            // --- 签到请求 ---
                            response = await fetch('/students_system/api/participant/checkin-auth', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${studentToken}`
                                },
                                body: JSON.stringify({
                                    activity_code: activityCode,
                                    latitude: lat,
                                    longitude: lon
                                })
                            });
                        } else {
                            // --- 签退请求 (修复点：直接赋值给 response，不要用 const) ---
                            response = await fetch('/students_system/api/participant/checkout-auth', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${studentToken}`
                                },
                                body: JSON.stringify({
                                    activity_code: activityCode,
                                    latitude: lat,
                                    longitude: lon
                                })
                            });
                        }

                        // --- 统一响应处理 (签到/签退共用) ---
                        
                        // 1. 尝试解析 JSON，防止解析空响应报错
                        try {
                            resultData = await response.json();
                        } catch (e) {
                            resultData = {}; 
                        }

                        // 2. 处理 401 未授权 (Token过期)
                        if (response.status === 401) {
                            alert('登录已过期，请重新登录');
                            localStorage.removeItem('student_token');
                            window.location.href = `student_login.html?redirect_code=${activityCode}`;
                            return;
                        }

                        // 3. 处理其他 HTTP 错误
                        if (!response.ok) {
                             throw new Error(resultData.detail || `服务器错误: ${response.status}`);
                        }

                        // 4. 处理业务逻辑拒绝 (后端返回 200 但包含 detail 错误信息)
                        if (resultData.detail) {
                            // --- 新增代码开始：自动引导切换身份 ---
                            if (resultData.detail.includes('组织不匹配')) {
                                if (confirm('检测到您当前的登录身份不属于该活动所在的组织/学校。\n\n需要重新登录以切换到该组织吗？')) {
                                    // 清除旧的 Token
                                    localStorage.removeItem('student_token');
                                    // 跳转到登录页 (带上当前活动的 code，以便重新注册/登录到正确的组织)
                                    window.location.href = `student_login.html?redirect_code=${activityCode}`;
                                    return;
                                }
                            }
                            // --- 新增代码结束 ---
                            
                            throw new Error(resultData.detail);
                        }

                        // 5. 成功逻辑 (根据类型更新 UI)
                        if (type === 'checkin') {
                            // 签到成功：记录临时凭证(可选)，显示签退按钮
                            localStorage.setItem(tokenStorageKey, resultData.device_session_token);
                            showMessage('签到成功!', false);
                            checkInForm.style.display = 'none';
                            checkOutForm.style.display = 'block';
                        } else {
                            // 签退成功：清除临时凭证，隐藏按钮
                            localStorage.removeItem(tokenStorageKey);
                            showMessage('签退成功!', false);
                            checkOutForm.style.display = 'none';
                            if(studentMarker) studentMarker.hide();
                        }

                    } catch (error) {
                        showMessage(`${error.message}`, true);
                    } finally {
                        checkInButton.disabled = false;
                        checkOutButton.disabled = false;
                    }
                } else {
                    let msg = '获取地理位置失败: ' + (result.message || '未知错误');
                    showMessage(msg, true);
                    checkInButton.disabled = false;
                    checkOutButton.disabled = false;
                }
            });
        }

        function showMessage(msg, isError) {
            messageDiv.innerText = msg;
            messageDiv.className = isError ? 'error' : 'success';
        }
    </script>
</body>
</html>